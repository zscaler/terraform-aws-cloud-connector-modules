# Zscaler Cloud Connector Cluster Infrastructure Setup

**Terraform configurations and modules for deploying Zscaler Cloud Connector Cluster in AWS.**

## Prerequisites (You will be prompted for AWS keys and region during deployment)

1. A valid AWS account
2. AWS ACCESS KEY ID
3. AWS SECRET ACCESS KEY
4. AWS Region (E.g. us-west-2)
5. Subscribe and accept terms of using CentOS 7 (for base deployments with workloads + bastion) at [this link](https://aws.amazon.com/marketplace/pp/B00O7WM7QW/).
6. Subscribe and accept terms of using Zscaler Cloud Connector image at [this link](https://aws.amazon.com/marketplace/pp/prodview-cvzx4oiv7oljm).
7. A valid Zscaler Cloud Connector provisioning URL
8. Zscaler Cloud Connector Credentials are stored in AWS Secrets Manager

## Deploying the cluster
(The automated tool can run only from MacOS and Linux)   
 
**1. Greenfield Deployments**

(Use this if you are building an entire cluster from ground up.
 Particularly useful for a Customer Demo/PoC or dev-test environment)

```
bash
cd aws/deployment/terraform
Edit the terraform.tfvars file under azure/deployment/terraform to setup your Cloud Connector(Details are documented inside the file)
./zsec up
```
**Greenfield Deployment Types:**

```
Deployment Type: (base | base_1cc | base_1cc_zpa | base_2cc | base_2cc_zpa | base_cc_gwlb | base_cc_gwlb_zpa | cc):
base: Creates 1 new VPC with 1 public subnet and 1 private/workload subnet; 1 IGW; 1 NAT Gateway; 1 Centos server workload in the private subnet routing to NAT Gateway;
1 Bastion Host in the public subnet assigned an Elastic IP and routing to the IGW; generates local key pair .pem file for ssh access
base_1cc: Base Deployment Type + Creates 1 Cloud Connector private subnet; 1 Cloud Connector VM routing to NAT Gateway; workload private subnet route repointed to service ENI of Cloud Connector
base_1cc_zpa: Everything from base_1cc Deployment Type + Creates 2 Route 53 subnets routing to service ENI of Cloud Connector; Route 53 outbound resolver endpoint; Route 53 resolver rules for ZPA
base_2cc: Everything from base_1cc + Creates a second Cloud Connector in a new subnet/AZ w/ Lambda for HA failover of workload route tables
base_2cc_zpa: Everything from Base_2cc + Creates 2 Route 53 subnets routing to service ENI of Cloud Connector; Route 53 outbound resolver endpoint; Route 53 resolver rules for ZPA
base_cc_gwlb: Base Deployment Type + Creates 4 Cloud Connectors (2 per subnet/AZ) routing to NAT Gateway; Gateway Load Balancer auto registering service ips to target group with health checks; VPC Endpoint Service; 2 GWLB Endpoints (1 in each Cloud Connector subnet); workload private subnet routes repointed to the GWLBE in their same AZ
base_cc_gwlb_zpa: Everything from base_cc_gwlb_zpa + Creates 2 Route 53 subnets routing to service ENI of Cloud Connector; Route 53 outbound resolver endpoint; Route 53 resolver rules for ZPA
```

## Destroying the cluster
```
./zsec destroy
```

## Notes

1. For auto approval set environment variable **AUTO_APPROVE** or add `export AUTO_APPROVE=1`
2. For deployment type set environment variable **DTYPE** to the required deployment type or add `export DTYPE=base_1cc_zpa`
3. To override the Cloud Connector instance type from m5.large, edit `ccvm_instance_type` in terraform.tfvars
4. To provide new credentials or region, delete the autogenerated .zsecrc file in your current working directory and re-run zsec.

**2. Brownfield Deployment Types**

```
Deployment Type: (cc_custom | cc_gwlb_custom):
cc_custom: Creates 1 new VPC with 2 public subnets and 2 Cloud Connector private subnets; 1 IGW; 2 NAT Gateways; 2 Cloud Connector VMs (1 per subnet/AZ) routing to the NAT Gateway in their same AZ; generates local key pair .pem file for ssh access; Number of Cloud Connectors and subnets deployed, ability to use existing resources (VPC, subnets, IGW, NAT Gateways), and toggle ZPA/R53 and Lambda HA failover features; generates local key pair .pem file for ssh access
cc_gwlb_custom: All options from cc_custom + Creates Gateway Load Balancer auto registering service ips to target group with health checks; VPC Endpoint Service; 1 GWLB Endpoints per Cloud Connector subnet
The following Cloud Connector terraform modules are provided for a brownfield deployment
```

ls aws/deployment/terraform/tfdir/modules
terraform-zscc-aws
terraform-zsroute53-aws
terraform-zslambda-aws
terraform-zsgwlbendpoint-aws
terraform-zsgwlb-aws
```